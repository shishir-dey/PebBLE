<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PebBLE</title>
    <link rel="stylesheet" href="style.css">
    <script src="gui-builder.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const browser = window.navigator.userAgent.toLowerCase();
            const isChrome = /chrome/.test(browser);
            const isEdge = /edge/.test(browser);

            const connectBtn = document.querySelector('#connect-button');

            if (isChrome || isEdge) {
                // connectBtn.textContent = 'Connected';
            } else {
                connectBtn.textContent = 'Unsupported Browser';
                connectBtn.style.backgroundColor = 'red';
                connectBtn.disabled = true;
            }

            fetchServicesFromLocalStorage();
        });

        function onConnectRequest() {
            const services = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('service-')) {
                    services.push(localStorage.getItem(key));
                }
            }

            navigator.bluetooth.requestDevice({
                acceptAllDevices: true,
                optionalServices: services
            })
                .then(device => {
                    return device.gatt.connect();

                }).then(server => {
                    const connectBtn = document.querySelector('#connect-button');
                    connectBtn.textContent = 'Fetching services...';
                    // connectBtn.style.backgroundColor = 'green';

                    console.log('Getting GATT Services...');
                    return server.getPrimaryServices();
                }).then(services => {
                    services.forEach(service => {
                        service.getCharacteristics().then(characteristics => {
                            let charGUIObjs = [];
                            characteristics.forEach(characteristic => {
                                console.log(characteristic.uuid);
                                const charGUIObj = createCharGUIObject(characteristic.uuid, `hexInput-${characteristic.uuid}`, `asciiInput-${characteristic.uuid}`, `decimalInput-${characteristic.uuid}`, characteristic.properties.read, characteristic.properties.write, characteristic.properties.notify, `readBtn-${characteristic.uuid}`, `writeBtn-${characteristic.uuid}`, `notifyBtn-${characteristic.uuid}`);
                                charGUIObjs.push(charGUIObj);
                            });
                            const serviceGUIObj = createServiceGUIObject(service.uuid, charGUIObjs);
                            document.querySelector('#main').appendChild(serviceGUIObj);
                        });
                    })
                    const connectBtn = document.querySelector('#connect-button');
                    connectBtn.textContent = 'Connected';
                    connectBtn.style.backgroundColor = 'green';
                }
                )
                ;
        }

        function fetchServicesFromLocalStorage() {

            let count = localStorage.getItem('count') ? parseInt(localStorage.getItem('count')) : 0;
            localStorage.setItem('count', count);

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('service-')) {
                    const label = document.createElement('label');
                    label.id = key.replace('service-', 'label-');
                    label.textContent = localStorage.getItem(key);
                    label.style.marginLeft = '10px';
                    label.style.marginRight = '10px';
                    document.querySelector('#service-list').appendChild(label);
                }
            }
        }

        function onAddServiceButtonClick() {
            const addServiceButton = document.querySelector('#add-service-button');
            const inputText = document.createElement('input');

            let count = localStorage.getItem('count') ? parseInt(localStorage.getItem('count')) : 0;
            localStorage.setItem('count', count);
            const inputId = `input-${count}`;

            count++;
            localStorage.setItem('count', count);

            inputText.id = inputId;

            inputText.type = 'text';
            inputText.style.marginTop = '5px';
            inputText.style.marginBottom = '5px';
            inputText.style.width = '100%';
            const serviceList = document.querySelector('#service-list');

            serviceList.appendChild(inputText);

            inputText.addEventListener('keypress', function (event) {
                if (event.key === 'Enter') {
                    const label = document.createElement('label');

                    label.id = `label-${count}`;
                    label.textContent = inputText.value;


                    label.style.marginLeft = '10px';
                    label.style.marginRight = '10px';
                    const localDatabase = window.localStorage;
                    if (!localDatabase.getItem(label.textContent)) {
                        localDatabase.setItem(`service-${count}`, inputText.value);
                    }
                    inputText.replaceWith(label);
                }
            });
        }
    </script>
</head>

<body>
    <div class="container">
        <aside class="sidebar">
            <h1 style="font-size: 2rem;">PebBLE</h1>
            <h5>*Works on Chrome and Edge</h5>


            <div class="horizontal-row">
                <h4>Service</h4>
                <button id="add-service-button" onclick="onAddServiceButtonClick()">+</button>

            </div>
            <div class="vertical-row" id="service-list"></div>

            <p style="font-size: 0.8rem;">Automatic discovery of services is not supported in Web Bluetooth.</p>
            <button id="connect-button" class="connect-btn" onclick="onConnectRequest()">Connect</button>

            <div style="margin-top: 50px;"></div>
            <div class="horizontal-row">
                <h4>Shortcuts</h4>
                <button>+</button>
            </div>
        </aside>
        <main class="content">
            <section class="">
                <h2 style=" font-size: 2rem;">Device</h2>
                <p id="mac" style="font-size: 1rem;">MAC: (not supported)</p>
                <p id="rssi">RSSI: (not supported)</p>
                <p id="conn-interval">Connection Interval: (not supported)</p>
            </section>
            <div class="card-container" id="main">
            </div>
        </main>
    </div>
</body>

</html>